<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.2.1" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
  font-size: .8em;
  background: #f0fff0;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
div.olist > ol {
  list-style-type: decimal;
}
div.olist2 > ol {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hlist td {
  padding-bottom: 15px;
}
td.hlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }

/* Because IE6 child selector is broken. */
div.olist2 ol {
  list-style-type: lower-alpha;
}
div.olist2 div.olist ol {
  list-style-type: decimal;
}
</style>
<title></title>
</head>
<body>
<div id="header">
<h1>Mem: invalidating the cache of build system convention</h1>
<span id="author">Scott R Parish</span><br />
<span id="email"><tt>&lt;<a href="mailto:sparish@peak6.com">sparish@peak6.com</a>&gt;</tt></span><br />
2009-01-20
</div>
<h2>Why a new build system?</h2>
<div class="sectionbody">
<div class="para"><p>There are no shortage of build systems, what justifies the existence
of yet another one?</p></div>
<div class="para"><p>Mem is a completely different approach to build systems, one base on
function memoization. Most build systems are based on building up some
static graph of dependencies and targets, traversing that graph while
minimally rebuilding, propagating changed objects across the graph for
calculating further steps; usually with very special languages and
sophisticated layers for automatically building the graph, easing
the job of the end user in describing their build.</p></div>
<div class="para"><p>Practically, mem is different in that:</p></div>
<div class="ilist"><ul>
<li>
<p>
the build is simply a script where certain functions are memoized (cached)
</p>
</li>
<li>
<p>
these memoized functions are only rebuilt if one of their inputs changes
</p>
</li>
</ul></div>
<div class="para"><p>The first part means that you can script your build however is most
natural to solve your specific build requirements, and mem sits in the
background and caches and avoids duplicate evaluations (eg needless
rebuilding).</p></div>
<div class="para"><p>The second part means exactly what it says. This can be startling at
first. For instance, suppose you had a <em>.c</em> file, and a build step to
compile it into an object and a build step to link that into a
program. If you make a whitespace change to that <em>.c</em> file, such as
changing a comment; the resulting object will likely be identical
(sha1) as the object before this change was made. Given that mem only
builds when things are changed, no relinking will be done as the
object to link will be unchanged!</p></div>
</div>
<h2>Memoization</h2>
<div class="sectionbody">
<div class="para"><p>To best understand the mem build system, we'll have to dive into the
theory of memoization. Bear with us, it's really not complicated and
we'll quickly be on our way to building stuff.</p></div>
<div class="quoteblock">
<div class="quoteblock-content">
<div class="para"><p>In computing, memoization is an optimization technique used primarily
to speed up computer programs by having function calls avoid repeating
the calculation of results for previously-processed inputs.</p></div>
<div class="attribution">
<span class="emphasis">Memoization</span><br />
&#8212; wikipedia
</div></div></div>
<div class="para"><p>A classic example of memoization is to allow writing a Fibonacci function
using the mathematical definition, e.g.:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>         / 0 if n = 0
F(n) = -{  1 if n = 1
         \ F(n-1) + F(n-2)</tt></pre>
</div></div>
<div class="para"><p>We could write this in Python as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p>The problem with this recursive definition is that <em>fib(n-1)</em> and
<em>fib(n-2)</em> for large values of <em>n</em> go through most of the same
computational steps, so we're wasting a huge (exponential) amount of
time recomputing the same thing over and over.</p></div>
<div class="para"><p>One solution is find a way to re-factor the equation so that we can
compute values in a more linear fashion (such as via
iteration). Sometimes this isn't desirable or possible.</p></div>
<div class="para"><p>Memoization is a different solution. Rather then rewriting the
solution to the equation, we introduce caching, which may look like
this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">,</span> cache<span style="color: #990000">={}):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> cache<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cache<span style="color: #990000">[</span>n<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
        cache<span style="color: #990000">[</span>n<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cache<span style="color: #990000">[</span>n<span style="color: #990000">]</span>
</tt></pre></div></div>
<div class="para"><p>We could abstract the caching so that it doesn't pollute our business
logic and so that we can reuse it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">memoize</span></span><span style="color: #990000">(</span>f<span style="color: #990000">):</span>
    cache <span style="color: #990000">=</span> <span style="color: #990000">{}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">wrapped_f</span></span><span style="color: #990000">(</span>arg<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> arg <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> cache<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cache
        cache<span style="color: #990000">[</span>arg<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">f</span></span><span style="color: #990000">(</span>arg<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cache<span style="color: #990000">[</span>arg<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> wrapped_f

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)</span>

fib <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">memoize</span></span><span style="color: #990000">(</span>fib<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p>And finally, rather then reassigning functions to memoize, we can use
<a href="http://www.python.org/dev/peps/pep-0318/">@decorators</a> to mark which
functions to memoize:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@memoize
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)</span>
</tt></pre></div></div>
</div>
<h2>Building on Memoization</h2>
<div class="sectionbody">
<div class="para"><p>Mem provides you with a handful of tools out of which you create a
memoized based build. The core of which is obviously memoization. Mem
actually provides a <em>memoize</em> function, very similar to the one we
developed in the previous section. The difference is mainly that mem's
memoization has to persist across build invocations, and it has to be
able to account for external data (e.g. files).</p></div>
<div class="para"><p>We already have enough information to write a simple build task for
creating an object from a <em>.c</em> file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> mem
<span style="font-weight: bold"><span style="color: #000080">import</span></span> subprocess

@mem<span style="color: #990000">.</span>memoize
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">obj</span></span><span style="color: #990000">(</span>target<span style="color: #990000">,</span> source<span style="color: #990000">):</span>
    mem<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_dep</span></span><span style="color: #990000">(</span>mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>source<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900"># declare external dependency</span></span>
    args <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"gcc"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"-o"</span><span style="color: #990000">,</span> target<span style="color: #990000">,</span> source<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> args                          <span style="font-style: italic"><span style="color: #9A1900"># let the user know what's happending</span></span>
    subprocess<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Popen</span></span><span style="color: #990000">(</span>args<span style="color: #990000">,</span> stdin <span style="color: #990000">=</span> PIPE<span style="color: #990000">,</span> stdout <span style="color: #990000">=</span> PIPE<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>target<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p>We call our build function just like you would any other Python
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">obj</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"hello.o"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"hello.c"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">for</span></span> src <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">[</span><span style="color: #FF0000">"hi.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"bye.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"hiagain.c"</span><span style="color: #990000">]:</span>
  <span style="font-weight: bold"><span style="color: #000000">obj</span></span><span style="color: #990000">(</span>src<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">replace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".o"</span><span style="color: #990000">),</span> src<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p><em>@mem.memoize</em> works largely like the memoize we saw earlier in that
it caches the result as a value on the key of the arguments that
passed to the function. There's a few extra things added:</p></div>
<div class="ilist"><ul>
<li>
<p>
<em>mem.add_dep()</em> is called to declare external dependencies, it can
  be called zero or more times anywhere within this function call
  (including sub-function calls). There's also <em>mem.add_deps()</em> which
  takes a list.
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="sidebar-content">
<div class="sidebar-title">Other external dependencies</div>
<div class="para"><p>There's nothing special about <em>mem.nodes.File()</em>, mem is writen so that
you can easily define your own types of external dependencies. For
example, it would be easy to write an S3() external dependency that
depended on objects in Amazon.com's S3 web-service. A database
dependency might be another potential.</p></div>
</div></div>
<div class="ilist"><ul>
<li>
<p>
A memoized function can return any Python data type, who's value
  will be cached. If the return value is a <em>File</em> (or a list of
  <em>Files</em>), then mem will also cache the contents of the files and
  restore them (if needed) on repeated duplicate calls.
</p>
</li>
</ul></div>
<div class="para"><p>Otherwise the above task is doing very straight-forward stuff:</p></div>
<div class="ilist"><ul>
<li>
<p>
building up the arguments to call the compiler with
</p>
</li>
<li>
<p>
logging to the user what's happening with the build
</p>
</li>
<li>
<p>
executing the build step&#8212;in this case the compiler
</p>
</li>
</ul></div>
<div class="para"><p>Again, there's absolutely no requirement that any of the arguments
be external (<em>File</em>) dependencies, nor that the result is an external
dependency. Mem will just as happily memoize the following (or even
the <em>fib()</em> we wrote earlier):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@mem<span style="color: #990000">.</span>memoize
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">render_hello</span></span><span style="color: #990000">(</span>name<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">"Hello, %s"</span> <span style="color: #990000">%</span> name
</tt></pre></div></div>
</div>
<h2>Environmental Impacts</h2>
<div class="sectionbody">
<div class="para"><p>Many build systems have some concept of an environment. For example,
it would be really nice if the <em>obj()</em> function we wrote earlier would
allow us to pass extra flags to the compiler.</p></div>
<div class="para"><p>Naively we could create an environment out of a dictionary and just
pass that into each build function:</p></div>
<div class="listingblock">
<div class="title">Example: Bad, avoid doing this!</div>
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> mem
<span style="font-weight: bold"><span style="color: #000080">import</span></span> subprocess

@mem<span style="color: #990000">.</span>memoize
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">obj</span></span><span style="color: #990000">(</span>target<span style="color: #990000">,</span> source<span style="color: #990000">,</span> env<span style="color: #990000">={}):</span>
    mem<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_dep</span></span><span style="color: #990000">(</span>mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>source<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900"># declare external dependency</span></span>
    cflags <span style="color: #990000">=</span> env<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"CFLAGS"</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
    args <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"gcc"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"-o"</span><span style="color: #990000">,</span> target<span style="color: #990000">,</span> source<span style="color: #990000">]</span> <span style="color: #990000">+</span> cflags
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> args                          <span style="font-style: italic"><span style="color: #9A1900"># let the user know what's happening</span></span>
    subprocess<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Popen</span></span><span style="color: #990000">(</span>args<span style="color: #990000">,</span> stdin <span style="color: #990000">=</span> PIPE<span style="color: #990000">,</span> stdout <span style="color: #990000">=</span> PIPE<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>target<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p>That works, but isn't optimal because now if the environment key
"SWIG_FLAGS" changes, all the <em>obj()</em> calls will be re-ran, even
though they don't make use of that part of the environment.</p></div>
<div class="para"><p>To avoid such problems, mem has defined another helpful decorator for
dealing with environment variables:
<em>@mem.util.with_env()</em>. <em>with_env()</em> takes a list of environment keys
(and defaults for if they are not found), pulls those keys out of the
environment and passes only those to the memoized part of the
function.</p></div>
<div class="para"><p>Here's a better version of <em>obj()</em> using <em>with_env()</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 2.11
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> mem
<span style="font-weight: bold"><span style="color: #000080">import</span></span> subprocess

@mem<span style="color: #990000">.</span>util<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">with_env</span></span><span style="color: #990000">(</span>CFLAGS<span style="color: #990000">=[])</span>         <span style="font-style: italic"><span style="color: #9A1900"># only pass-in CFLAGS from the environment</span></span>
@mem<span style="color: #990000">.</span>memoize
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">obj</span></span><span style="color: #990000">(</span>target<span style="color: #990000">,</span> source<span style="color: #990000">,</span> CFLAGS<span style="color: #990000">):</span>
    mem<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_dep</span></span><span style="color: #990000">(</span>mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>source<span style="color: #990000">))</span> <span style="font-style: italic"><span style="color: #9A1900"># declare external dependency</span></span>
    args <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"gcc"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"-o"</span><span style="color: #990000">,</span> target<span style="color: #990000">,</span> source<span style="color: #990000">]</span> <span style="color: #990000">+</span> CFLAGS
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> args                          <span style="font-style: italic"><span style="color: #9A1900"># let the user know what's happending</span></span>
    subprocess<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Popen</span></span><span style="color: #990000">(</span>args<span style="color: #990000">,</span> stdin <span style="color: #990000">=</span> PIPE<span style="color: #990000">,</span> stdout <span style="color: #990000">=</span> PIPE<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> mem<span style="color: #990000">.</span>nodes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">File</span></span><span style="color: #990000">(</span>target<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="para"><p><em>mem.util.with_env</em> should always come before <em>mem.memoize</em> or it
won't have the full desired effect.</p></div>
<div class="sidebarblock">
<div class="sidebar-content">
<div class="para"><p>There's nothing that ties <em>mem.util.with_env</em> into <em>mem.memoize</em>. They
are useful together, but <em>mem.util.with_env</em> can be just as useful
alone.</p></div>
</div></div>
<h3>The <em>Env</em> class</h3><div style="clear:left"></div>
<div class="para"><p>Mem does provide an <em>mem.util.Env</em> class that extends the base <em>dict</em>
class. It's not very exciting; it mainly provides:</p></div>
<div class="ilist"><ul>
<li>
<p>
Access using attributes: e.g. <em>env.CFLAGS</em> is the same as
  <em>env["CFLAGS"]</em>
</p>
</li>
<li>
<p>
<em>subst()</em> method which allows for string expansion using the
  environment. For instance if <em>env.ROOT = "/foo"</em> then,
  <em>env.subst("%(ROOT)s/bar")</em> would return <em>/foo/bar</em>
</p>
</li>
<li>
<p>
<em>replace()</em> method which allows for easily setting/replacing
  environment entries, in mass, along with automatic <em>subst()</em>
  expansion
</p>
</li>
</ul></div>
</div>
<h2>Memfiles</h2>
<div class="sectionbody">
<h3>Startup</h3><div style="clear:left"></div>
<div class="para"><p>When mem is ran, it initializes itself, searches down the directory
tree (towards the root) for the first directory with a <em>MemfileRoot</em>
in it, it imports this file, and then runs the <em>build()</em> function from
it, which should take no arguments.</p></div>
<h3>Sub-Directories</h3><div style="clear:left"></div>
<div class="para"><p>Mem has primitive support for allowing a build to span multiple
directories. The core of this functionality is the form
<em>mem.subdir(mydir)</em>, which will import the file <em>mydir/Memfile</em>. It
returns a wrapped module such that anytime you call a function on it:</p></div>
<div class="ilist"><ul>
<li>
<p>
changes env.cwd and the process's cwd to "mydir"
</p>
</li>
<li>
<p>
calls the function, passing any arguments given
</p>
</li>
<li>
<p>
restores env.cwd and the process's cwd
</p>
</li>
</ul></div>
<div class="para"><p>The intent behind changing the directory is to make things like
http://docs.python.org/library/glob.html#glob.glob more
convenient for the user writing the script.</p></div>
<div class="sidebarblock">
<div class="sidebar-content">
<div class="sidebar-title">Build functions and CWD</div>
<div class="para"><p>Build functions generally print to the user any commands that are
being run, so the user know where the build broke, or how its
proceeding. As far as possible it's suggested that, build functions
should strive to accept absolute or relative paths, but only run and
print using absolute paths.</p></div>
<div class="para"><p>The rational for doing so is that a user can then, from any directory,
copy and paste an offending command without having to figure out what
directory he has to be in to run it.</p></div>
</div></div>
</div>
<h2>Writing your own build functions</h2>
<div class="sectionbody">
<div class="para"><p>Mem basically just provides some core functionality which you can use
to build your own build functions with. Mem does ship with a few example
build functions which are much more full featured (great for
complicated use, but harder to understand).</p></div>
<div class="para"><p>In general, here's some of the things you might want to consider when
writing a new build function:</p></div>
<div class="ilist"><ul>
<li>
<p>
Scanning: if the source(s) can depend on other files, probably
  recursivelly, the build will only be correct if you correctly scan
  and identify all of these dependencies and declare them using
  <em>mem.add_dep()</em>. It doesn't have to be very hard, some compilers
  (eg gcc, swig) come with something like <em>make depends</em> which is a
  mode where they will automatically spit out a list of dependencies
  (read the manual for gcc's <em>-M</em> flag). Many other dependencies can
  be easily parsed out by a fairly simple regular expression.
</p>
</li>
<li>
<p>
Returning all targets: just as important as scanning to get all
  included dependencies is returning all of the results of a build
  function. Lets say your compiler produces two output files, but you
  only return one of those from your build function, but use the
  second file later in your build; since mem wasn't notified that the
  second file was a result, it won't restore it, meaning that later on
  in the build it could be stale or even missing.
</p>
</li>
<li>
<p>
Try to keep the memoized functions as simple as possible&#8212;typically
  they are leaf functions. Not everything has to be memoized
  though, so a common practice is to have large complicated
  non-memoized functions that are written in terms of several simple,
  primitive memoized functions. For example, in the <em>obj()</em> we
  developed in this document, it would be handy if it automatically
  guessed the target name if none was given. It would be best to do
  such calculation in an outer non-memoized function which then calls
  the simpler memoized <em>obj()</em>.
</p>
</li>
<li>
<p>
Use common sense and good programming style. Mem leaves you with the
  full programming language in-tact; there's no excuse for using bad
  practices you wouldn't do in your normal programming.
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="sidebar-content">
<div class="sidebar-title">Exceptions</div>
<div class="para"><p>When we said that "Mem leaves the full programming language in-tact",
there's no better way to illustrate this then exceptions. You can
raise and catch exceptions just like you normally would in python. This
can be very useful, for example, you might still want to run your
documentation generation and cscopes indexer even if the rest of the
build fails.</p></div>
</div></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 14-Feb-2009 08:34:44 CDT
</div>
</div>
</body>
</html>
